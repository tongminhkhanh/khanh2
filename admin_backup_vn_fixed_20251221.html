<!DOCTYPE html>
<html lang="vi">

<head>
    <script>
        // Early auth check - redirect to login if no token
        if (!localStorage.getItem('admin-token')) {
            window.location.href = '/admin-login.html';
        }
    </script>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/public/logo.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tr∆∞·ªùng Ti·ªÉu h·ªçc √çt Ong</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/public/css/main.css">
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-4 text-center">ƒêƒÉng nh·∫≠p Admin</h2>
            <form id="login-form" class="flex flex-col gap-4">
                <input type="text" id="login-username" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="border p-2 rounded" required>
                <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u" class="border p-2 rounded" required>
                <button type="submit" class="btn btn-primary w-full">ƒêƒÉng nh·∫≠p</button>
            </form>
            <p id="auth-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="p-4 border-b border-gray-700">
                <h1 class="text-xl font-bold">Admin Panel</h1>
            </div>
            <nav class="flex-1 p-4">
                <a href="#" id="nav-articles"
                    class="flex items-center gap-2 px-4 py-2 rounded bg-blue-600 text-white mb-2">
                    <span>B√†i vi·∫øt</span>
                </a>
                <a href="#" id="nav-events"
                    class="flex items-center gap-2 px-4 py-2 rounded text-gray-300 hover:bg-gray-700 mb-2">
                    <span>S·ª± ki·ªán</span>
                </a>
                <a href="#" id="nav-media"
                    class="flex items-center gap-2 px-4 py-2 rounded text-gray-300 hover:bg-gray-700 mb-2">
                    <span>Th∆∞ vi·ªán ·∫£nh</span>
                </a>
                <a href="#" id="nav-pages"
                    class="flex items-center gap-2 px-4 py-2 rounded text-gray-300 hover:bg-gray-700 mb-2">
                    <span>Trang tƒ©nh</span>
                </a>
                <a href="#" id="nav-settings"
                    class="flex items-center gap-2 px-4 py-2 rounded text-gray-300 hover:bg-gray-700 mb-2">
                    <span>C√†i ƒë·∫∑t</span>
                </a>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold"
                        id="user-avatar">A</div>
                    <div>
                        <p class="text-sm font-medium" id="user-name">Admin</p>
                        <p class="text-xs text-gray-400" id="user-role">Administrator</p>
                    </div>
                </div>
                <button id="logout-btn" class="mt-4 w-full text-sm text-red-400 hover:text-red-300 text-left">ƒêƒÉng
                    xu·∫•t</button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow z-10">
                <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                    <h1 class="text-2xl font-bold text-gray-900" id="page-title">Qu·∫£n l√Ω B√†i vi·∫øt</h1>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto bg-gray-100 p-6">
                <!-- Articles Section -->
                <div id="section-articles">
                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">Th√™m b√†i vi·∫øt m·ªõi</h2>
                        <form id="article-form" class="space-y-4">
                            <input type="hidden" id="article-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ</label>
                                    <input type="text" id="title"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Danh m·ª•c</label>
                                    <select id="category"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="Tin tuc">Tin t·ª©c</option>
                                        <option value="S·ª± ki·ªán">S·ª± ki·ªán</option>
                                        <option value="Hoat dong">Ho·∫°t ƒë·ªông</option>
                                        <option value="Thong bao">Th√¥ng b√°o</option>
                                        <option value="Thanh tich">Th√†nh t√≠ch</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tr·∫°ng th√°i</label>
                                    <select id="status"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="draft">Nh√°p</option>
                                        <option value="pending">Ch·ªù duy·ªát</option>
                                        <option value="published">ƒê√£ xu·∫•t b·∫£n</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Tags</label>
                                    <input type="text" id="tags"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        placeholder="tag1, tag2">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">H√¨nh ·∫£nh (URL)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="image"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <button type="button" onclick="openMediaSelector('image')"
                                        class="mt-1 bg-gray-200 px-3 rounded hover:bg-gray-300">Ch·ªçn</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">N·ªôi dung</label>
                                <div class="border border-gray-300 rounded-md shadow-sm mt-1 bg-white">
                                    <div id="article-toolbar"
                                        class="border-b border-gray-300 p-2 bg-gray-50 flex gap-2 flex-wrap items-center">
                                    </div>
                                    <div id="article-editor"
                                        class="p-4 min-h-[300px] prose max-w-none focus:outline-none"></div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="btn btn-primary">Luu bai
                                    viet</button>
                                <button type="button" id="cancel-edit" class="btn btn-secondary hidden">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Hinh
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tieu de
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Danh muc
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trang
                                        thai</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hanh
                                        dong</th>
                                </tr>
                            </thead>
                            <tbody id="articles-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Events Section -->
                <div id="section-events" class="hidden">
                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">Qu·∫£n l√Ω S·ª± ki·ªán</h2>
                        <form id="event-form" class="space-y-4">
                            <input type="hidden" id="event-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ s·ª± ki·ªán</label>
                                    <input type="text" id="event-title"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Lo·∫°i s·ª± ki·ªán</label>
                                    <select id="event-type"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="public">S·ª± ki·ªán chung</option>
                                        <option value="class">S·ª± ki·ªán l·ªõp</option>
                                        <option value="teacher">S·ª± ki·ªán gi√°o vi√™n</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Target Grade/Class (only for class events) -->
                            <div id="event-target-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"
                                style="display: none;">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Kh·ªëi l·ªõp tham d·ª±</label>
                                    <select id="event-target-grade"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                        <option value="">T·∫•t c·∫£ c√°c kh·ªëi</option>
                                        <option value="1">Kh·ªëi 1</option>
                                        <option value="2">Kh·ªëi 2</option>
                                        <option value="3">Kh·ªëi 3</option>
                                        <option value="4">Kh·ªëi 4</option>
                                        <option value="5">Kh·ªëi 5</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">L·ªõp c·ª• th·ªÉ (t√πy ch·ªçn)</label>
                                    <input type="text" id="event-target-class"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        placeholder="VD: 1A, 2B, 3C...">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ng√†y b·∫Øt ƒë·∫ßu</label>
                                    <input type="datetime-local" id="event-start"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ng√†y k·∫øt th√∫c</label>
                                    <input type="datetime-local" id="event-end"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        required>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ƒê·ªãa ƒëi·ªÉm</label>
                                    <input type="text" id="event-location"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        placeholder="VD: Hoi truong, San truong...">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Danh m·ª•c s·ª± ki·ªán</label>
                                    <select id="event-category"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        onchange="updateEventColor()">
                                        <option value="exam" data-color="#dc2626">üî¥ L·ªãch thi / Ki·ªÉm tra</option>
                                        <option value="activity" data-color="#2563eb">üîµ Ho·∫°t ƒë·ªông ngo·∫°i kh√≥a / Ch√†o c·ªù
                                        </option>
                                        <option value="holiday" data-color="#16a34a">üü¢ L·ªãch ngh·ªâ l·ªÖ / H·ªçp ph·ª• huynh
                                        </option>
                                        <option value="other" data-color="#6b7280">‚ö™ Kh√°c</option>
                                    </select>
                                    <input type="hidden" id="event-color" value="#dc2626">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">M√¥ t·∫£</label>
                                <textarea id="event-description" rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="event-published"
                                        class="form-checkbox h-5 w-5 text-blue-600" checked>
                                    <span class="ml-2 text-gray-700">Xu·∫•t b·∫£n ngay</span>
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="btn btn-primary">Luu su
                                    kien</button>
                                <button type="button" id="cancel-event-edit"
                                    class="btn btn-secondary hidden">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tieu de
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thoi
                                        gian</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dia diem
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trang
                                        thai</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hanh
                                        dong</th>
                                </tr>
                            </thead>
                            <tbody id="events-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Media Section -->
                <div id="section-media" class="hidden">
                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">Th∆∞ vi·ªán ·∫¢nh</h2>
                            <label class="btn btn-primary cursor-pointer">
                                <span>T·∫£i ·∫£nh l√™n</span>
                                <input type="file" id="media-upload" class="hidden" accept="image/*">
                            </label>
                        </div>
                        <div id="media-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                </div>

                <!-- Pages Section -->
                <div id="section-pages" class="hidden">
                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">Qu·∫£n l√Ω Trang tƒ©nh</h2>
                        <form id="page-form" class="space-y-4">
                            <input type="hidden" id="page-id">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ</label>
                                    <input type="text" id="page-title-input"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                        required oninput="generateSlug()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Slug (URL)</label>
                                    <input type="text" id="page-slug"
                                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-50"
                                        required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">N·ªôi dung</label>
                                <div class="border border-gray-300 rounded-md shadow-sm mt-1 bg-white">
                                    <div id="page-toolbar"
                                        class="border-b border-gray-300 p-2 bg-gray-50 flex gap-2 flex-wrap items-center">
                                    </div>
                                    <div id="page-editor" class="p-4 min-h-[300px] prose max-w-none focus:outline-none">
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="page-published"
                                        class="form-checkbox h-5 w-5 text-blue-600">
                                    <span class="ml-2 text-gray-700">Xu·∫•t b·∫£n ngay</span>
                                </label>
                            </div>
                            <div class="flex gap-2">
                                <button type="submit" class="btn btn-primary">Luu
                                    trang</button>
                                <button type="button" id="cancel-page-edit"
                                    class="btn btn-secondary hidden">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white shadow sm:rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tieu de
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slug
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trang
                                        thai</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Hanh
                                        dong</th>
                                </tr>
                            </thead>
                            <tbody id="pages-list" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="section-settings" class="hidden">

                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">C√†i ƒë·∫∑t Thanh th√¥ng b√°o (Ticker)</h2>
                        <form id="ticker-settings-form" class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="ticker-enabled"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="ticker-enabled" class="ml-2 block text-sm text-gray-900">Bat thanh thong
                                    bao</label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">N·ªôi dung hi·ªÉn th·ªã</label>
                                <textarea id="ticker-content-input" rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    placeholder="Nh·∫≠p n·ªôi dung ch·∫°y tr√™n thanh ticker..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Luu
                                cai dat</button>
                        </form>
                    </div>

                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">C√†i ƒë·∫∑t chung</h2>
                        <form id="urgent-notice-form" class="space-y-4">
                            <div class="flex items-center gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="urgent-enabled"
                                        class="form-checkbox h-5 w-5 text-red-600">
                                    <span class="ml-2 text-gray-700 font-bold">B·∫≠t th√¥ng b√°o kh·∫©n</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">N·ªôi dung th√¥ng b√°o</label>
                                <textarea id="urgent-content" rows="3"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">ƒê∆∞·ªùng d·∫´n (t√πy ch·ªçn)</label>
                                <input type="text" id="urgent-link"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                                    placeholder="https://...">
                            </div>
                            <button type="submit" class="btn btn-primary">Luu
                                cai dat</button>
                        </form>
                    </div>
                    <div class="bg-white shadow sm:rounded-lg p-6 mb-8">
                        <h2 class="text-xl font-bold mb-4">Th√¥ng ƒëi·ªáp t·ª´ Hi·ªáu Tr∆∞·ªüng</h2>
                        <form id="principal-message-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Ti√™u ƒë·ªÅ</label>
                                <input type="text" id="principal-title"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">N·ªôi dung</label>
                                <textarea id="principal-content" rows="5"
                                    class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Luu
                                thong diep</button>
                        </form>
                    </div>
            </main>
        </div>
    </div>
    <!-- Media Modal -->
    <div id="media-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[80vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Ch·ªçn ·∫£nh</h3>
                <button onclick="closeMediaModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-media-grid" class="grid grid-cols-4 gap-4"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let token = localStorage.getItem('admin-token');
        let currentUser = null;

        let mediaSelectCallback = null;
        let mediaSelectInputId = null;

        // Auth Functions
        function showAuth() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('user-name').innerText = currentUser.username;
                document.getElementById('user-role').innerText = currentUser.role ? currentUser.role.toUpperCase() : 'USER';
                document.getElementById('user-avatar').innerText = currentUser.username ? currentUser.username.charAt(0).toUpperCase() : 'A';
            }
            fetchArticles();
        }

        function showError(msg) {
            const el = document.getElementById('auth-error');
            el.innerText = msg;
            el.classList.remove('hidden');
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (res.ok) {
                    localStorage.setItem('admin-token', data.token);
                    token = data.token;
                    currentUser = { username: data.username, role: data.role };
                    showDashboard();
                } else {
                    showError(data.message || 'Login failed');
                }
            } catch (err) {
                showError('L·ªói k·∫øt n·ªëi server');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('admin-token');
            window.location.href = '/admin-login.html';
        });

        // Navigation
        const navLinks = {
            'nav-articles': 'section-articles',
            'nav-events': 'section-events',
            'nav-media': 'section-media',
            'nav-pages': 'section-pages',
            'nav-settings': 'section-settings'
        };
        const titles = {
            'nav-articles': 'Qu·∫£n l√Ω B√†i vi·∫øt',
            'nav-events': 'Qu·∫£n l√Ω S·ª± ki·ªán',
            'nav-media': 'Th∆∞ vi·ªán ·∫¢nh',
            'nav-pages': 'Trang tƒ©nh',
            'nav-settings': 'C√†i ƒë·∫∑t chung'
        };

        Object.keys(navLinks).forEach(id => {
            document.getElementById(id).addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('aside nav a').forEach(l => l.classList.remove('bg-blue-600', 'text-white'));
                document.querySelectorAll('aside nav a').forEach(l => l.classList.add('text-gray-300'));
                e.currentTarget.classList.remove('text-gray-300');
                e.currentTarget.classList.add('bg-blue-600', 'text-white');
                Object.values(navLinks).forEach(s => document.getElementById(s).classList.add('hidden'));
                document.getElementById(navLinks[id]).classList.remove('hidden');
                document.getElementById('page-title').textContent = titles[id];
                if (id === 'nav-articles') fetchArticles();
                if (id === 'nav-events') fetchEvents();
                if (id === 'nav-media') fetchMedia();
                if (id === 'nav-pages') fetchPages();
                if (id === 'nav-settings') { fetchSettings(); }
            });
        });

        // Articles
        async function fetchArticles() {
            const tbody = document.getElementById('articles-list');
            // Skeleton loading
            tbody.innerHTML = Array(5).fill(0).map(() => `
                <tr class="skeleton-row">
                    <td class="px-6 py-4"><div class="skeleton h-10 w-10 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-3/4 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/2 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/4 rounded"></div></td>
                    <td class="px-6 py-4 text-right"><div class="skeleton h-8 w-16 rounded ml-auto"></div></td>
                </tr>
            `).join('');

            try {
                const res = await fetch(`${API_URL}/articles`);
                const articles = await res.json();

                if (!articles || articles.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-gray-500">
                                    <svg class="w-12 h-12 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10l4 4v10a2 2 0 01-2 2z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 2v4a2 2 0 002 2h4"></path>
                                    </svg>
                                    <p class="text-lg font-medium">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
                                    <p class="text-sm">H√£y t·∫°o b√†i vi·∫øt ƒë·∫ßu ti√™n c·ªßa b·∫°n.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = articles.map(a => `
                    <tr>
                        <td class="px-6 py-4">${a.image ? `<img src="${a.image}" class="h-10 w-10 rounded object-cover">` : '<div class="h-10 w-10 rounded bg-gray-200"></div>'}</td>
                        <td class="px-6 py-4 font-medium">${a.title}</td>
                        <td class="px-6 py-4 text-gray-500">${a.category}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${a.status === 'published' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${a.status}</span></td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editArticle('${a._id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">S·ª≠a</button>
                            <button onclick="deleteArticle('${a._id}')" class="text-red-600 hover:text-red-900">X√≥a</button>
                        </td>
                    </tr>
                `).join('');

                // Ticker Settings (also fetch here to ensure it's loaded)
                const tickerRes = await fetch(`${API_URL}/settings/ticker_settings`);
                const tickerData = await tickerRes.json();
                if (tickerData.value) {
                    document.getElementById('ticker-enabled').checked = tickerData.value.isEnabled || false;
                    document.getElementById('ticker-content-input').value = tickerData.value.content || '';
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>`;
            }
        }

        document.getElementById('article-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('article-id').value;
            const content = window.articleEditor ? window.articleEditor.getHTML() : '';
            const article = {
                title: document.getElementById('title').value,
                content: content,
                category: document.getElementById('category').value,
                image: document.getElementById('image').value,
                status: document.getElementById('status').value,
                tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t)
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/articles/${id}` : `${API_URL}/articles`;
            try {
                const res = await fetch(url, {
                    method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(article)
                });
                if (res.ok) { resetArticleForm(); fetchArticles(); alert('ƒê√£ l∆∞u b√†i vi·∫øt!'); }
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        window.editArticle = async (id) => {
            const res = await fetch(`${API_URL}/articles/${id}`);
            const a = await res.json();
            if (a) {
                document.getElementById('article-id').value = a._id;
                document.getElementById('title').value = a.title;
                if (window.articleEditor) window.articleEditor.commands.setContent(a.content || '');
                document.getElementById('category').value = a.category;
                document.getElementById('image').value = a.image || '';
                document.getElementById('status').value = a.status;
                document.getElementById('tags').value = (a.tags || []).join(', ');
                document.getElementById('cancel-edit').classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        };

        window.deleteArticle = async (id) => {
            showConfirmDialog({
                title: 'X√≥a b√†i vi·∫øt?',
                message: 'B√†i vi·∫øt s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ ho√†n t√°c.',
                confirmText: 'X√≥a',
                cancelText: 'H·ªßy',
                onConfirm: async () => {
                    await fetch(`${API_URL}/articles/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchArticles();
                    showToast('success', 'ƒê√£ x√≥a b√†i vi·∫øt!');
                }
            });
        };

        document.getElementById('cancel-edit').addEventListener('click', resetArticleForm);

        function resetArticleForm() {
            document.getElementById('article-form').reset();
            document.getElementById('article-id').value = '';
            if (window.articleEditor) window.articleEditor.commands.setContent('');
            document.getElementById('cancel-edit').classList.add('hidden');
        }

        // Events
        async function fetchEvents() {
            const tbody = document.getElementById('events-list');
            // Skeleton loading
            tbody.innerHTML = Array(5).fill(0).map(() => `
                <tr class="skeleton-row">
                    <td class="px-6 py-4"><div class="skeleton h-4 w-3/4 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/2 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/2 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/4 rounded"></div></td>
                    <td class="px-6 py-4 text-right"><div class="skeleton h-8 w-16 rounded ml-auto"></div></td>
                </tr>
            `).join('');

            try {
                const res = await fetch(`${API_URL}/admin/events`, { headers: { 'Authorization': `Bearer ${token}` } });
                const events = await res.json();

                if (!events || events.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-gray-500">
                                    <svg class="w-12 h-12 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="text-lg font-medium">Ch∆∞a c√≥ s·ª± ki·ªán n√†o</p>
                                    <p class="text-sm">H√£y t·∫°o s·ª± ki·ªán ƒë·∫ßu ti√™n c·ªßa b·∫°n.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = events.map(e => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${e.title}</td>
                        <td class="px-6 py-4 text-gray-500">${new Date(e.startDate).toLocaleDateString('vi-VN')}</td>
                        <td class="px-6 py-4 text-gray-500">${e.location || '-'}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${e.isPublished ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${e.isPublished ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nhap'}</span></td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editEvent('${e._id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">S·ª≠a</button>
                            <button onclick="deleteEvent('${e._id}')" class="text-red-600 hover:text-red-900">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>`;
            }
        }

        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('event-id').value;
            const eventType = document.getElementById('event-type').value;
            const event = {
                title: document.getElementById('event-title').value,
                description: document.getElementById('event-description').value,
                startDate: document.getElementById('event-start').value,
                endDate: document.getElementById('event-end').value,
                type: eventType,
                location: document.getElementById('event-location').value,
                color: document.getElementById('event-color').value,
                isPublished: document.getElementById('event-published').checked,
                targetGrade: eventType === 'class' ? document.getElementById('event-target-grade').value : null,
                targetClass: eventType === 'class' ? document.getElementById('event-target-class').value : null
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/events/${id}` : `${API_URL}/events`;
            try {
                const res = await fetch(url, {
                    method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(event)
                });
                if (res.ok) { resetEventForm(); fetchEvents(); alert('ƒê√£ l∆∞u s·ª± ki·ªán!'); }
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        window.editEvent = async (id) => {
            const res = await fetch(`${API_URL}/admin/events`, { headers: { 'Authorization': `Bearer ${token}` } });
            const events = await res.json();
            const e = events.find(x => x._id === id);
            if (e) {
                document.getElementById('event-id').value = e._id;
                document.getElementById('event-title').value = e.title;
                document.getElementById('event-description').value = e.description || '';
                document.getElementById('event-start').value = new Date(e.startDate).toISOString().slice(0, 16);
                document.getElementById('event-end').value = new Date(e.endDate).toISOString().slice(0, 16);
                document.getElementById('event-type').value = e.type || 'public';
                document.getElementById('event-location').value = e.location || '';
                setEventCategoryByColor(e.color || '#dc2626');
                document.getElementById('event-color').value = e.color || '#dc2626';
                document.getElementById('event-published').checked = e.isPublished;
                document.getElementById('event-target-grade').value = e.targetGrade || '';
                document.getElementById('event-target-class').value = e.targetClass || '';
                toggleEventTargetFields();
                document.getElementById('cancel-event-edit').classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        };

        window.deleteEvent = async (id) => {
            showConfirmDialog({
                title: 'X√≥a s·ª± ki·ªán?',
                message: 'S·ª± ki·ªán s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ ho√†n t√°c.',
                confirmText: 'X√≥a',
                cancelText: 'H·ªßy',
                onConfirm: async () => {
                    await fetch(`${API_URL}/events/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchEvents();
                    showToast('success', 'ƒê√£ x√≥a s·ª± ki·ªán!');
                }
            });
        };

        document.getElementById('cancel-event-edit').addEventListener('click', resetEventForm);

        function resetEventForm() {
            document.getElementById('event-form').reset();
            document.getElementById('event-id').value = '';
            document.getElementById('event-category').value = 'exam';
            document.getElementById('event-color').value = '#dc2626';
            document.getElementById('event-target-grade').value = '';
            document.getElementById('event-target-class').value = '';
            document.getElementById('event-target-container').style.display = 'none';
            document.getElementById('cancel-event-edit').classList.add('hidden');
        }

        // Toggle target fields visibility based on event type
        function toggleEventTargetFields() {
            const eventType = document.getElementById('event-type').value;
            const container = document.getElementById('event-target-container');
            container.style.display = eventType === 'class' ? 'grid' : 'none';
        }

        // Add event listener for type change
        document.getElementById('event-type').addEventListener('change', toggleEventTargetFields);

        // Update color based on category selection
        function updateEventColor() {
            const select = document.getElementById('event-category');
            const color = select.options[select.selectedIndex].getAttribute('data-color');
            document.getElementById('event-color').value = color;
        }

        // Set category dropdown based on saved color
        function setEventCategoryByColor(color) {
            const select = document.getElementById('event-category');
            const colorMap = {
                '#dc2626': 'exam',
                '#2563eb': 'activity',
                '#16a34a': 'holiday',
                '#6b7280': 'other'
            };
            select.value = colorMap[color] || 'other';
        }

        // Media
        async function fetchMedia() {
            const grid = document.getElementById('media-grid');
            // Skeleton loading
            grid.innerHTML = Array(6).fill(0).map(() => `
                <div class="skeleton h-24 w-full rounded"></div>
            `).join('');

            try {
                const res = await fetch(`${API_URL}/media`, { headers: { 'Authorization': `Bearer ${token}` } });
                const media = await res.json();

                if (!media || media.length === 0) {
                    grid.innerHTML = `<div class="col-span-full py-12 text-center text-gray-500">Ch∆∞a c√≥ ·∫£nh n√†o</div>`;
                    return;
                }

                grid.innerHTML = media.map(m => `
                    <div class="relative group">
                        <img src="${m.path}" class="w-full h-24 object-cover rounded cursor-pointer" onclick="copyMediaUrl('${m.path}')">
                        <button onclick="deleteMedia('${m._id}')" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                grid.innerHTML = `<div class="col-span-full py-4 text-center text-red-500">L·ªói khi t·∫£i ·∫£nh</div>`;
            }
        }

        document.getElementById('media-upload').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const formData = new FormData();
                formData.append('file', e.target.files[0]);
                try {
                    const res = await fetch(`${API_URL}/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (res.ok) { fetchMedia(); alert('ƒê√£ t·∫£i ·∫£nh l√™n!'); }
                    else { const d = await res.json(); alert('L·ªói: ' + d.message); }
                } catch (err) { console.error(err); }
            }
        });

        window.copyMediaUrl = (url) => {
            navigator.clipboard.writeText(url);
            alert('ƒê√£ sao ch√©p URL!');
        };

        window.deleteMedia = async (id) => {
            showConfirmDialog({
                title: 'X√≥a ·∫£nh?',
                message: '·∫¢nh s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ ho√†n t√°c.',
                confirmText: 'X√≥a',
                cancelText: 'H·ªßy',
                onConfirm: async () => {
                    await fetch(`${API_URL}/media/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchMedia();
                    showToast('success', 'ƒê√£ x√≥a ·∫£nh!');
                }
            });
        };

        // Media Selector Modal
        window.openMediaSelector = async (inputId, callback) => {
            mediaSelectInputId = inputId;
            mediaSelectCallback = callback;
            const modal = document.getElementById('media-modal');
            modal.classList.remove('hidden');
            const grid = document.getElementById('modal-media-grid');
            grid.innerHTML = Array(4).fill(0).map(() => `<div class="skeleton h-24 w-full rounded"></div>`).join('');
            try {
                const res = await fetch(`${API_URL}/media`, { headers: { 'Authorization': `Bearer ${token}` } });
                const media = await res.json();
                grid.innerHTML = media.map(m => `
                    <img src="${m.path}" class="w-full h-24 object-cover rounded cursor-pointer hover:ring-2 hover:ring-blue-500" onclick="selectMedia('${m.path}')">
                `).join('');
            } catch (err) { console.error(err); }
        };

        window.selectMedia = (url) => {
            if (mediaSelectCallback) {
                mediaSelectCallback(url, { alt: 'Image' });
            } else if (mediaSelectInputId) {
                document.getElementById(mediaSelectInputId).value = url;
            }
            closeMediaModal();
        };

        window.closeMediaModal = () => {
            document.getElementById('media-modal').classList.add('hidden');
            mediaSelectCallback = null;
            mediaSelectInputId = null;
        };

        // Pages
        async function fetchPages() {
            const tbody = document.getElementById('pages-list');
            tbody.innerHTML = Array(3).fill(0).map(() => `
                <tr class="skeleton-row">
                    <td class="px-6 py-4"><div class="skeleton h-4 w-3/4 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/2 rounded"></div></td>
                    <td class="px-6 py-4"><div class="skeleton h-4 w-1/4 rounded"></div></td>
                    <td class="px-6 py-4 text-right"><div class="skeleton h-8 w-16 rounded ml-auto"></div></td>
                </tr>
            `).join('');

            try {
                const res = await fetch(`${API_URL}/admin/static-pages`, { headers: { 'Authorization': `Bearer ${token}` } });
                const pages = await res.json();

                if (!pages || pages.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">Ch∆∞a c√≥ trang n√†o</td></tr>`;
                    return;
                }

                tbody.innerHTML = pages.map(p => `
                    <tr>
                        <td class="px-6 py-4 font-medium">${p.title}</td>
                        <td class="px-6 py-4 text-gray-500">${p.slug}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${p.isPublished ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">${p.isPublished ? 'ƒê√£ xu·∫•t b·∫£n' : 'Nhap'}</span></td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="editPage('${p._id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">S·ª≠a</button>
                            <button onclick="deletePage('${p._id}')" class="text-red-600 hover:text-red-900">X√≥a</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>`;
            }
        }

        window.generateSlug = () => {
            const title = document.getElementById('page-title-input').value;
            const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            document.getElementById('page-slug').value = slug;
        };

        document.getElementById('page-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('page-id').value;
            const content = window.pageEditor ? window.pageEditor.getHTML() : '';
            const page = {
                title: document.getElementById('page-title-input').value,
                slug: document.getElementById('page-slug').value,
                content: content,
                isPublished: document.getElementById('page-published').checked
            };
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/admin/static-pages/${id}` : `${API_URL}/admin/static-pages`;
            try {
                const res = await fetch(url, {
                    method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(page)
                });
                if (res.ok) { resetPageForm(); fetchPages(); alert('ƒê√£ l∆∞u trang!'); }
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        window.editPage = async (id) => {
            const res = await fetch(`${API_URL}/admin/static-pages`, { headers: { 'Authorization': `Bearer ${token}` } });
            const pages = await res.json();
            const p = pages.find(x => x._id === id);
            if (p) {
                document.getElementById('page-id').value = p._id;
                document.getElementById('page-title-input').value = p.title;
                document.getElementById('page-slug').value = p.slug;
                if (window.pageEditor) window.pageEditor.commands.setContent(p.content || '');
                document.getElementById('page-published').checked = p.isPublished;
                document.getElementById('cancel-page-edit').classList.remove('hidden');
                window.scrollTo(0, 0);
            }
        };

        window.deletePage = async (id) => {
            showConfirmDialog({
                title: 'X√≥a trang?',
                message: 'Trang s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ ho√†n t√°c.',
                confirmText: 'X√≥a',
                cancelText: 'H·ªßy',
                onConfirm: async () => {
                    await fetch(`${API_URL}/admin/static-pages/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    fetchPages();
                    showToast('success', 'ƒê√£ x√≥a trang!');
                }
            });
        };

        document.getElementById('cancel-page-edit').addEventListener('click', resetPageForm);

        function resetPageForm() {
            document.getElementById('page-form').reset();
            document.getElementById('page-id').value = '';
            if (window.pageEditor) window.pageEditor.commands.setContent('');
            document.getElementById('cancel-page-edit').classList.add('hidden');
        }

        // Settings
        async function fetchSettings() {
            try {
                // Ticker Settings
                const tickerRes = await fetch(`${API_URL}/settings/ticker_settings`);
                const tickerData = await tickerRes.json();
                if (tickerData.value) {
                    document.getElementById('ticker-enabled').checked = tickerData.value.isEnabled || false;
                    document.getElementById('ticker-content-input').value = tickerData.value.content || '';
                }

                // Urgent Notice
                const urgentRes = await fetch(`${API_URL}/settings/urgent_notice`);
                const urgentData = await urgentRes.json();
                if (urgentData.value) {
                    document.getElementById('urgent-enabled').checked = urgentData.value.isEnabled || false;
                    document.getElementById('urgent-content').value = urgentData.value.content || '';
                    document.getElementById('urgent-link').value = urgentData.value.link || '';
                }

                // Principal Message
                const principalRes = await fetch(`${API_URL}/settings/principal_message`);
                const principalData = await principalRes.json();
                if (principalData.value) {
                    document.getElementById('principal-title').value = principalData.value.title || '';
                    document.getElementById('principal-content').value = principalData.value.content || '';
                }
            } catch (err) { console.error(err); }
        }

        document.getElementById('urgent-notice-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                isEnabled: document.getElementById('urgent-enabled').checked,
                content: document.getElementById('urgent-content').value,
                link: document.getElementById('urgent-link').value
            };
            try {
                const res = await fetch(`${API_URL}/admin/settings/urgent_notice`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ value: data, description: 'Th√¥ng b√°o kh·∫©n' })
                });
                if (res.ok) alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t!');
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        document.getElementById('principal-message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('principal-title').value,
                content: document.getElementById('principal-content').value
            };
            try {
                const res = await fetch(`${API_URL}/admin/settings/principal_message`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ value: data, description: 'Th√¥ng ƒëi·ªáp Hi·ªáu Tr∆∞·ªüng' })
                });
                if (res.ok) alert('ƒê√£ l∆∞u th√¥ng ƒëi·ªáp!');
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        document.getElementById('ticker-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                isEnabled: document.getElementById('ticker-enabled').checked,
                content: document.getElementById('ticker-content-input').value
            };
            try {
                const res = await fetch(`${API_URL}/admin/settings/ticker_settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ value: data, description: 'C√†i ƒë·∫∑t Ticker Bar' })
                });
                if (res.ok) alert('ƒê√£ l∆∞u c√†i ƒë·∫∑t Ticker!');
                else { const d = await res.json(); alert('L·ªói: ' + d.message); }
            } catch (err) { console.error(err); }
        });

        // Init
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;
                showDashboard();
            } catch (e) {
                showAuth();
            }
        } else {
            showAuth();
        }
    </script>

    <script type="module">
        import { Editor } from 'https://esm.sh/@tiptap/core';
        import StarterKit from 'https://esm.sh/@tiptap/starter-kit';
        import Image from 'https://esm.sh/@tiptap/extension-image';
        import Youtube from 'https://esm.sh/@tiptap/extension-youtube';
        import Link from 'https://esm.sh/@tiptap/extension-link';
        import TextAlign from 'https://esm.sh/@tiptap/extension-text-align';

        function setupEditor(elementId, toolbarId) {
            const editor = new Editor({
                element: document.getElementById(elementId),
                extensions: [
                    StarterKit,
                    Image.configure({
                        inline: true,
                        allowBase64: true,
                    }),
                    Youtube.configure({
                        controls: false,
                    }),
                    Link.configure({
                        openOnClick: false,
                    }),
                    TextAlign.configure({
                        types: ['heading', 'paragraph'],
                    }),
                ],
                content: '',
                editorProps: {
                    attributes: {
                        class: 'prose max-w-none focus:outline-none',
                    },
                },
            });

            const toolbar = document.getElementById(toolbarId);

            const buttons = [
                { label: 'Bold', action: () => editor.chain().focus().toggleBold().run(), isActive: () => editor.isActive('bold') },
                { label: 'Italic', action: () => editor.chain().focus().toggleItalic().run(), isActive: () => editor.isActive('italic') },
                { label: 'H2', action: () => editor.chain().focus().toggleHeading({ level: 2 }).run(), isActive: () => editor.isActive('heading', { level: 2 }) },
                { label: 'H3', action: () => editor.chain().focus().toggleHeading({ level: 3 }).run(), isActive: () => editor.isActive('heading', { level: 3 }) },
                { label: 'List', action: () => editor.chain().focus().toggleBulletList().run(), isActive: () => editor.isActive('bulletList') },
                { label: 'Ordered', action: () => editor.chain().focus().toggleOrderedList().run(), isActive: () => editor.isActive('orderedList') },
                {
                    label: 'Link', action: () => {
                        const previousUrl = editor.getAttributes('link').href;
                        const url = window.prompt('URL', previousUrl);
                        if (url === null) return;
                        if (url === '') { editor.chain().focus().extendMarkRange('link').unsetLink().run(); return; }
                        editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
                    }, isActive: () => editor.isActive('link')
                },
                {
                    label: 'Image', action: () => {
                        window.openMediaSelector(null, (url) => {
                            if (url) editor.chain().focus().setImage({ src: url }).run();
                        });
                    }, isActive: () => false
                },
                {
                    label: 'YouTube', action: () => {
                        const url = prompt('Enter YouTube URL');
                        if (url) { editor.chain().focus().setYoutubeVideo({ src: url }).run(); }
                    }, isActive: () => editor.isActive('youtube')
                },
                { label: 'Left', action: () => editor.chain().focus().setTextAlign('left').run(), isActive: () => editor.isActive({ textAlign: 'left' }) },
                { label: 'Center', action: () => editor.chain().focus().setTextAlign('center').run(), isActive: () => editor.isActive({ textAlign: 'center' }) },
                { label: 'Right', action: () => editor.chain().focus().setTextAlign('right').run(), isActive: () => editor.isActive({ textAlign: 'right' }) },
            ];

            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'toolbar-btn';
                button.innerText = btn.label;
                button.onclick = btn.action;
                toolbar.appendChild(button);

                // Update button state
                editor.on('transaction', () => {
                    if (btn.isActive()) button.classList.add('is-active');
                    else button.classList.remove('is-active');
                });
            });

            return editor;
        }

        // Initialize editors
        window.articleEditor = setupEditor('article-editor', 'article-toolbar');
        window.pageEditor = setupEditor('page-editor', 'page-toolbar');
    </script>

    <!-- Admin UI Enhancements -->
    <script src="/public/admin-ui-enhancements.js"></script>
</body>

</html>